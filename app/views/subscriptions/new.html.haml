-# render 'shared/error_messages', target: @subscription

- @body_attributes = { 'data-no-turbolink' => true }

:coffeescript
  $(document).on 'page:change page:ready', ->
    $('#address').toggle($("#subscription_delivery").val() == "true")
    $('#subscription_delivery').on 'change', ->
      $('#address').toggle($("#subscription_delivery").val() == "true")

    $('#subscription_frequency').on 'change', ->
      $('#week-fn').text($("#subscription_frequency").val().replace("ly",""))


=form_for ([@season, @subscription]) do |f|
  .row
    .small-8.columns.small-centered.text-center
      %h2 Choose A Box Size
  .row{ 'data-equalizer' => true }
    - Subscription::SIZES.each do |key,box|
      .small-12.medium-4.columns.text-center.chunky
        .panel
          .offset-bottom{ 'data-equalizer-watch' => true }
            %h4= "#{box[:name]} (#{box[:price]})"
            %p= box[:desc]
          =f.radio_button :box_size, key
          =f.label :box_size, "Choose", value: key, class: 'button'

    .row
      .small-12.columns.text-center
        = first_error_for @subscription, :box_size
    .row
      .small-12.columns.text-center
        %p
          You can always change your box size at a later date, as long as you let us know by
          %strong Sunday evening.

  .row
    .small-12.columns
      %h2 Box Options
  .row
    .small-12.medium-6.columns{ class: "#{error_class(@subscription,:delivery)}" }
      =f.label :delivery, "Collection or Delivery?"
      =f.select :delivery, [['Collection from 4/133 North Road, Warragul (Free)', false],['Delivery to Warragul or Drouin ($5.00)', true]]
      = first_error_for @subscription, :delivery
    .small-12.medium-6.columns{ class: "#{error_class(@subscription,:frequency)}" }
      =f.label :frequency, "Weekly or Fortnightly?"
      =f.select :frequency, [['Weekly', 'weekly'],['Fortnightly', 'fortnightly']]
      = first_error_for @user, :frequency

  - if @raw_token
    = hidden_field_tag :raw_token, @raw_token

  - unless current_user || @raw_token
    %br
    .row
      .small-12.columns
        %h2 Your details
    =f.fields_for :user, @user do |uf|
      .row
        .small-12.medium-6.columns{ class: "#{error_class(@user,:given_name)}" }
          =uf.label :given_name
          =uf.text_field :given_name
          = first_error_for @user, :given_name
        .small-12.medium-6.columns{ class: "#{error_class(@user,:surname)}" }
          =uf.label :surname
          =uf.text_field :surname
          = first_error_for @user, :surname
      .row
        .small-12.medium-6.columns{ class: "#{error_class(@user,:email)}" }
          =uf.label :email
          =uf.text_field :email
          = first_error_for @user, :email
        .small-12.medium-6.columns{ class: "#{error_class(@user,:phone)}" }
          =uf.label :phone
          =uf.text_field :phone
          = first_error_for @user, :phone
      .row
        .small-12.medium-6.columns{ class: "#{error_class(@user,:password)}" }
          =uf.label :password do
            Password
            %span.has-tip{ 'data-tooltip' => true, 'aria-haspopup' => true, title: "A password is required so that you can update your info later and subscribe to subsequent seasons with the same account." }
              (Why?)
          =uf.password_field :password
          = first_error_for @user, :password
        .small-12.medium-6.columns{ class: "#{error_class(@user,:password_confirmation)}" }
          =uf.label :password_confirmation
          =uf.password_field :password_confirmation
          = first_error_for @user, :password_confirmation

  #address
    .row
      .small-12.columns{ class: "#{error_class(@subscription,:street_address)}" }
        =f.label :street_address, "Street Address (For Delivery)"
        =f.text_field :street_address
        = first_error_for @subscription, :street_address
    .row
      .small-12.medium-6.columns{ class: "#{error_class(@subscription,:town)}" }
        =f.label :town
        =f.text_field :town
        = first_error_for @subscription, :town
      .small-12.medium-6.columns{ class: "#{error_class(@subscription,:postcode)}" }
        =f.label :postcode
        =f.text_field :postcode
        = first_error_for @subscription, :postcode
  %br
  .row
    .small-12.columns.text-center
      %p
        Your first pickup time will be Tuesday the
        %strong= readable_date(@season.first_pack_day_with_lead_time_after(Time.now).pack_date)
        between 3pm and 6pm.
  .row
    .small-8.small-centered.columns.text-center
      %p
        By clicking 'Sign up' you acknowledge that you are responsible for collecting a vegetable box of your nominated size
        %strong each
        %strong#week-fn week
        from the
        %strong= readable_date(@season.first_pack_day_with_lead_time_after(Time.now).pack_date)
        onwards.

  %br
  .row
    .small-4.small-centered.columns.text-center
      = submit_tag "Sign up!", class: 'button red'
